# Vibma Setup Guide

> **This guide assumes you've cloned the repo and are running commands from the project root.** If you haven't yet:
> ```bash
> git clone https://github.com/ufira-ai/vibma.git
> cd vibma
> ```
> Looking for a zero-download setup instead? See [CARRYME.md](./CARRYME.md).

## Prerequisites

- [Node.js](https://nodejs.org) (v18+)
- [Figma](https://figma.com) desktop or web app
- An AI coding tool with MCP support (Claude Code, Cursor, etc.)

## 1. Install dependencies

```bash
npm install
npm run build
```

## 2. Start the WebSocket relay

This bridges the MCP server and the Figma plugin via channels. Everything runs locally on your machine — no data leaves localhost.

```bash
npm run socket
```

You should see: `WebSocket server running on port 3055`

### About ports

Vibma defaults to port **3055**. The Figma plugin manifest whitelists ports **3055–3058** so you have alternatives if 3055 is already in use (e.g., by the upstream cursor-talk-to-figma-mcp project). To use a different port, set the `VIBMA_PORT` env var:

```bash
VIBMA_PORT=3056 npm run socket
```

The MCP server reads the same env var, so it will match automatically. You only need to also update the **port field in the Figma plugin UI** before clicking Connect.

The Figma plugin can only connect to ports 3055, 3056, 3057, or 3058. This is a Figma platform restriction — the manifest's `allowedDomains` cannot be changed at runtime.

## 3. Install the Figma plugin

1. In Figma, go to **Plugins > Development > Import plugin from manifest...**
2. Select `plugin/manifest.json` from this repo (generated by `npm run build`)
3. Run the plugin — it will show a connection panel

## 4. Configure MCP in your AI tool

Add to your MCP config (e.g. `.cursor/mcp.json`, `.claude.json`, or `.mcp.json`):

```json
{
  "mcpServers": {
    "Vibma": {
      "command": "node",
      "args": ["/absolute/path/to/vibma/dist/mcp.js"]
    }
  }
}
```

Or run from source (no build step, good for development):

```json
{
  "mcpServers": {
    "Vibma": {
      "command": "npx",
      "args": ["tsx", "/absolute/path/to/vibma/src/mcp.ts"]
    }
  }
}
```

If using a non-default port, pass `--port=`:

```json
{
  "mcpServers": {
    "Vibma": {
      "command": "node",
      "args": ["/absolute/path/to/vibma/dist/mcp.js", "--port=3056"]
    }
  }
}
```

> **Note:** Replace `/absolute/path/to/vibma` with the actual path to your cloned repo. To find it, run `pwd` from the vibma directory. MCP clients don't set a working directory, so relative paths won't resolve.

## 5. Connect

1. In the Figma plugin, set the channel name to `vibma` (or any name you like)
2. Click **Connect**
3. In your AI tool, call `join_channel` with the same channel name (defaults to `vibma`)
4. Call `ping` — you should get back `pong` with your document name

### Channel rules

Each channel enforces **exactly one Figma plugin and one MCP server**. If a second plugin (or second MCP) tries to join a channel that's already occupied, it will be rejected with a clear error message. To connect a different plugin, disconnect the first one or use a different channel name.

### Debugging connections

Use the relay's built-in debug endpoint to see who's connected:

```bash
curl http://localhost:3055/channels
```

Returns:
```json
{
  "vibma": {
    "mcp": { "connected": true, "version": "0.1.1", "joinedAt": "2026-02-28T12:00:00.000Z" },
    "plugin": { "connected": true, "version": "0.1.1", "joinedAt": "2026-02-28T12:00:01.000Z" }
  }
}
```

If using Claude Code, the `channel_info` MCP tool returns the same data without leaving your AI tool.

## Troubleshooting

**Plugin won't connect to WebSocket**: Make sure the relay is running. The plugin connects to `ws://localhost:3055` by default.

**"Connection rejected" in plugin UI**: Another plugin is already connected to that channel. Disconnect it first or use a different channel name. Run `curl http://localhost:3055/channels` to see what's connected.

**MCP shows disconnected**: Restart your AI tool after changing MCP config. Stdio-based MCP servers can't hot-reload.

**Port already in use**: See the agent instructions below for automated port resolution, or manually kill the process (`lsof -ti:3055 | xargs kill`).

**Version mismatch warning**: The plugin and MCP server are running different versions. Run `npm run build` and restart both to resolve.

---

## Instructions for AI Agents

The section below is for AI agents setting up Vibma on behalf of a user. Follow these steps in order.

### Port resolution

Before starting the socket relay, check if the default port is available:

```bash
lsof -ti:3055
```

If the port is occupied, ask the user:

> Port 3055 is already in use by another process (PID: <pid>). Would you like to:
> 1. **Kill the process** on port 3055 and use it for Vibma
> 2. **Use the next available port** (3056, 3057, or 3058)

If the user chooses option 2, scan ports in order:

```bash
lsof -ti:3056 || echo "3056 is free"
lsof -ti:3057 || echo "3057 is free"
lsof -ti:3058 || echo "3058 is free"
```

Use the first free port. Set `VIBMA_PORT=<port>` when starting the relay, and pass `--port=<port>` to the MCP server in the MCP config. Inform the user to set the same port in the Figma plugin UI before clicking Connect.

If all four ports (3055–3058) are occupied, tell the user they need to free one.

### Connection verification

After the user opens the Figma plugin, it should automatically show **Connected** on the default port (3055). If a non-default port was used, the user will need to select the correct port in the plugin UI and click Connect.

1. Call `join_channel` (defaults to channel `vibma` — use a different name only if the user specifies one).
2. Call `ping`. Expected response: `{ status: "pong", documentName: "...", currentPage: "...", timestamp: ... }`

If `ping` returns a `pong` with a document name, the full chain is verified. Proceed with design tasks.

### Troubleshooting connection issues

If the plugin shows **Disconnected** on port 3055, try the following before asking the user:

1. Check the relay is running: `lsof -ti:3055` — if no output, the relay isn't started.
2. Restart the relay: `npm run socket`
3. Ask the user to close and reopen the Figma plugin.

If `join_channel` fails with a `ROLE_OCCUPIED` error, another MCP server is already connected to that channel. Use `channel_info` (or `curl http://localhost:3055/channels`) to inspect who's connected. The user needs to disconnect the other MCP client or use a different channel name.

If the issue persists after these steps, direct the user to the [Vibma Discord](https://discord.gg/4XTedZdwV6) for help.

If any tool times out after a successful `join_channel`, the Figma plugin is not connected to the relay. The timeout error will include the port and channel the MCP server is using. Ask the user to check the Figma plugin window and confirm:
- The **port** matches what MCP is using
- The **channel name** matches what MCP joined
- The plugin status shows **Connected**
