# Vibma Setup Guide

## Prerequisites

- [Bun](https://bun.sh) runtime
- [Figma](https://figma.com) desktop or web app
- An AI coding tool with MCP support (Claude Code, Cursor, etc.)

## 1. Install dependencies

```bash
bun install
bun run build
```

## 2. Generate SSL certificates

The WebSocket server requires TLS because Figma plugins run in an HTTPS context and browsers block mixed content (`wss://` not `ws://`).

```bash
mkdir -p certs
openssl req -x509 -newkey rsa:2048 -keyout certs/key.pem -out certs/cert.pem -days 365 -nodes -subj "/CN=localhost"
```

## 3. Start the WebSocket relay

This bridges the MCP server and the Figma plugin via channels. Everything runs locally on your machine — no data leaves localhost.

```bash
SSL_KEY_PATH=certs/key.pem SSL_CERT_PATH=certs/cert.pem bun socket
```

You should see: `WebSocket server running on port 3055`

### About ports

Vibma defaults to port **3055**. The Figma plugin manifest whitelists ports **3055–3058** so you have alternatives if 3055 is already in use (e.g., by the upstream cursor-talk-to-figma-mcp project). To use a different port, set the `VIBMA_PORT` env var:

```bash
SSL_KEY_PATH=certs/key.pem SSL_CERT_PATH=certs/cert.pem VIBMA_PORT=3056 bun socket
```

The MCP server reads the same env var, so it will match automatically. You only need to also update the **port field in the Figma plugin UI** before clicking Connect.

The Figma plugin can only connect to ports 3055, 3056, 3057, or 3058. This is a Figma platform restriction — the manifest's `allowedDomains` cannot be changed at runtime.

## 4. Install the Figma plugin

1. In Figma, go to **Plugins > Development > Import plugin from manifest...**
2. Select `plugin/manifest.json` from this repo (generated by `bun run build`)
3. Run the plugin — it will show a connection panel

## 5. Configure MCP in your AI tool

Add to your MCP config (e.g. `.cursor/mcp.json`, `.claude.json`, or `.mcp.json`):

```json
{
  "mcpServers": {
    "Vibma": {
      "command": "node",
      "args": ["dist/mcp.js"]
    }
  }
}
```

Or run from source (no build step, good for development):

```json
{
  "mcpServers": {
    "Vibma": {
      "command": "bun",
      "args": ["run", "src/mcp.ts"]
    }
  }
}
```

## 6. Connect

1. In the Figma plugin, optionally set a custom channel name (or leave blank for a random one)
2. Click **Connect** — note the channel name shown
3. In your AI tool, call `join_channel` with that channel name
4. Test with `get_document_info` — you should get back your Figma document structure

## Troubleshooting

**Plugin won't connect to WebSocket**: Make sure the SSL certs exist and the relay is running. The plugin connects to `wss://localhost:3055` by default.

**MCP shows disconnected**: Restart your AI tool after changing MCP config. Stdio-based MCP servers can't hot-reload.

**Port already in use**: See the agent instructions below for automated port resolution, or manually kill the process (`lsof -ti:3055 | xargs kill`).

---

## Instructions for AI Agents

The section below is for AI agents setting up Vibma on behalf of a user. Follow these steps in order.

### Port resolution

Before starting the socket relay, check if the default port is available:

```bash
lsof -ti:3055
```

If the port is occupied, ask the user:

> Port 3055 is already in use by another process (PID: <pid>). Would you like to:
> 1. **Kill the process** on port 3055 and use it for Vibma
> 2. **Use the next available port** (3056, 3057, or 3058)

If the user chooses option 2, scan ports in order:

```bash
lsof -ti:3056 || echo "3056 is free"
lsof -ti:3057 || echo "3057 is free"
lsof -ti:3058 || echo "3058 is free"
```

Use the first free port. Set `VIBMA_PORT=<port>` when starting the relay and MCP server. Inform the user to set the same port in the Figma plugin UI before clicking Connect.

If all four ports (3055–3058) are occupied, tell the user they need to free one.

### Connection verification

After the user says they've connected the Figma plugin:

1. Call `join_channel` with the channel name shown in the Figma plugin UI.
2. Call `ping`. Expected response: `{ status: "pong", documentName: "...", currentPage: "...", timestamp: ... }`

If `ping` returns a `pong` with a document name, the full chain is verified — MCP server, relay, plugin, and Figma are all talking. Proceed with design tasks.

**If `join_channel` fails** (timeout or connection refused):
- Confirm the relay is running (`bun socket` terminal still active)
- Confirm the port matches between relay, MCP config, and plugin UI
- Check SSL certs exist at the paths specified in `SSL_KEY_PATH` and `SSL_CERT_PATH`

**If `ping` fails** (join succeeded but no pong):
- The Figma plugin is not connected to the relay. Ask the user to:
  1. Open the Figma plugin panel
  2. Confirm the status shows "Connected" with the correct channel name
  3. If disconnected, click Connect and ensure the port matches the relay
